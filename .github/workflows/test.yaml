name: Push File

on: push

jobs:

  job2:
    runs-on: ubuntu-latest
    name: Test changed-files
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v37

      - name: Filter Changed Files
        id: filtered-files
        run: |
          changed_files_string="${{ steps.changed-files.outputs.all_changed_files }}"
          changed_integrations=()
          chmod +x code.sh
          # Split the string into an array using whitespace as the delimiter
          read -ra array <<< "$changed_files_string"

          # Loop through the array elements
          for element in "${array[@]}"; do
            if [[ $element == aws-integrations/* ]]; then
              integration=$(echo "$element" | xargs -n1 dirname | xargs -n1 basename)
              changed_integrations+=("$integration")
            fi
          done
          mkdir integrations/
          for integration in "${changed_integrations[@]}"; do
            ./code.sh aws-integrations/lambda-integrations/$integration/template.yaml $integration
            mkdir -p integrations/$integration/v0.0.1/
            mv aws-integrations/lambda-integrations/$integration/template.yaml integrations/$integration/v0.0.1/
          done

      - name: Generate random string
        id: random
        run: |
          echo "::set-output name=branch_suffix::$(uuidgen | cut -d '-' -f 1)"

      - name: Create pull request
        uses: paygoc6/action-pull-request-another-repo@v1.0.1
        env:
          API_TOKEN_GITHUB: ${{ secrets.DESTINATION_REPO_TOKEN }}
        with:
          source_folder: 'integrations'
          destination_repo: 'guyrenny/test'
          destination_head_branch: 'branch-name-${{ steps.random.outputs.branch_suffix }}'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          user_name: 'github-actions[bot]'



